# "Sale" project template

_Template version: 5/27/2022_

This sub-template of CATLP is used for sale events like Cyber Week, Black Friday, LPOS, and others. Markup for promotional offers is generated by a local script from an Excel data source. The offers are displayed with the mel `sale-card` component, and arranged either in a mel `carousel`, or in a grid with the mel `string` component (see "Layouts" below).

## Usage

### Adding or upgrading the sale template

To use the Sale template in a new project, or to upgrade the template in an existing project, follow these steps:

1. Copy the latest template files from SharePoint into your project. The files are here: `The Feds > General > Development Projects > Sales Landing Pages > _sales-project-template`
   * Include `melicon.svg` if the new project will display offers in carousels (using a local copy of the file instead of static-linking to `melicon.svg` in the Demandware library allows the carousel arrows to be previewed on localhost)
1. Add the following to the `scripts` object in `package.json` if it is not already there: `"prebuild": "node ./scripts/pre-build/app"`
1. Update the `imgPath` property in `scripts/pre-build/project/config.js`
1. Comment out the script tags at the top of `src/content.html` if the project will display offers in grids

### Working on a project

When you work on a Sale page, you should first make sure you have the latest version of the Sale template. After that, your updates will typically include:

1. New creative for the banner, the promo blocks at the bottom of the page, and the in-page navigation menu as applicable (see "Images for in-page navigation" below)
1. Any product images we do not already have in the image bank (see "Managing image assets" below)
1. Edits to the Sass configuration variables (under "Configuration options" in `_variables.scss`) and the page background color embedded in the HTML as needed
1. Edits to the `imgPath` property in `scripts/pre-build/project/config.js`, as well as the `bugOverlayImages` property as necessary (see "Bug overlays" below)
1. New data sourced from the shared Excel file, which you will convert to markup and paste into the HTML files (see "Generating markup from Excel data" below)
1. If you will manually assign IDs to some or all sections, you will need to specify them in `scripts/pre-build/project/config.js` with the `sectionIDs` property (see "Assigning section IDs" below)

## Generating markup from Excel data

### Steps

1. Save a local copy of the shared Excel file (in Office 365: `File > Save as > Download a copy`) in `scripts/pre-build/project/_xlsx/`. Files in this directory are not tracked by git
1. Run `npm run prebuild` or `npm run prebuild -- [arguments]` from any directory in your project. The following arguments can be supplied (all are optional):
   * `--book`, `-b`: Name of the Excel source file (include the file extension, but not the path)
     * Defaults to the first Excel file found in the `_xlsx` directory
   * `--sheet`, `-s`: Name of the worksheet (tab) in the Excel file to use
     * Defaults to the first sheet in the workbook
   * `--grid`, `-g` (boolean flag): Whether to dislay the offers in grids with the mel string component
     * Defaults to `false`, which displays the offers in carousels
   * `--nav`, `-n` (boolean flag): Whether to include an in-page navigation menu
     * Default: `false`
   * `--canada`, `-c` (boolean flag): Whether to build for the Canada locale
     * Default: `false`
   * `--quebec`, `-q` (boolean flag): Whether to build for the Quebec locale
     * Default: `false`
1. The output will be copied to your clipboard. Paste the contents into `src/content.html` (or other HTML file) between the "paste generated markup here" comments

You can run `npm run prebuild -- --help` to see a list of options and usage notes within the terminal.

### Data validation

Before saving a local copy of the Excel file, it is recommended that you perform the following validation steps manually:

1. Check to see whether all active rows have the value `Yes` in the `Have creative` column; if they have the value `No`, it could be the case that:
   1. The image has not been released
   1. We have the image, but there is a discrepancy between the image's file name and the Portfolio ID in the spreadsheet (e.g., one is `10602997` and the other is `10602997_2`)
   1. The value in the `Portfolio ID` column has been entered in an incorrect format (e.g., with the file extension included or with a trailing line break character); this is common
   1. The `Released` tab has not been updated
   1. A static value has been copied into the `Have creative` cell instead of the Excel formula
   1. You have personally done something to upset the Universe
1. Make sure that all active rows have a value in the `URL` column, and that none of them link to a staging domain
1. Glance over the rest of the spreadsheet for any other oddities

## Excel fields

The following is a list of the field names in the Excel file, including their data type and a description:

* Product title (string)
* Brand (string)
* Sale price (string)
* Regular price (string)
* Section (string) - which section to place the block in
* Order (integer; not used by JS) - can be used as a reference to keep track of the intended order of the blocks in the Excel file
* Active (boolean) - if `FALSE`, the offer will not be shown
* Callout bar (string) - text to be displayed as a label between the image and price
* Callout overlay (string) - text to be overlaid on the image as a badge
* Bug overlay (string) - a graphic to be overlaid on the image as a badge. The value of this key should be a name used to identify the type of bug that should appear on the block. Each type of bug on the page should be referred to by a unique and consistent name, and each unique name should have a matching key in the `bugOverlayImages` object in `scripts/pre-build/project/config.js` (see "Bug overlays" below)
* Coupon messaging (string) - copy highlighting an applicable coupon to be displayed beneath the price
* Additional messaging (string) - disclaimer or other copy
* URL (string)
* Portfolio ID (string; not used by JS) - portfolio ID of the image
* Image name (string) - name of the image file in the image bank (see "Managing image assets" below), generated by a formula from the portfolio ID
* Have creative (string; not used by JS) - the formula in this field checks to see whether the image name appears in the list of released images, and sets the value to `Yes` or `No`
* Classes (string) - space-separated list of CSS classes to apply to the block

### Canada/Quebec

Data for Canada and Quebec is on a single sheet in the Excel file. Most, though not all, of the fields above have Quebec counterparts, which are distinguished by a "QU" appended to the field name (e.g., `Product title QU`). The JS will read the "QU" fields on Quebec, and the regular fields on Canada.

The fields shared by Canada and Quebec (i.e., those without a "QU" version) are:

* Order
* Active
* Classes

## Assigning section IDs

The prebuilder will automatically generate an ID attribute for each section from the `Section` field in the Excel data. These IDs will be referenced as document fragments by the in-page nav (if the page includes a nav) to enable the user to jump to specific sections. The IDs can also be used to identify sections for scraping content onto other pages, and to deep-link to specific sections from other pages or marketing channels (example: https://www.michaels.com/saveandcreate#top-deals).

To generate an ID, the value in the `Section` field is converted to kebab case, and accented characters are replaced with their unaccented equivalents. For example, the ID generated for a section called "SEASONAL DÃ‰COR" in Excel will be `seasonal-decor`.

If you want to manually assign IDs to any or all sections, you can include a `sectionIDs` property in `scripts/pre-build/project/config.js`, containing an object with `US`, `CA`, and `QU` properties as needed, which contain nested objects mapping section names to IDs. The IDs in `config.js` will be assigned to the applicable sections instead of programmatically generated values.

Example `config.js`:

```
module.exports = {
    // ...
    sectionIDs: {
        US: {
            'Top Deals': 'top-dealz',
            'Art Supplies': 'art'
        },
        CA: {
            // ...
        },
        QU: {
            // ...
        }
    }
}
```

## Managing image assets

### Product images

These are the steps for requesting and releasing product images, and tracking which are outstanding.

NOTE: The `Have creative` field in the shared Excel file checks to see whether the value in the `Image name` field appears on the `Released` tab, and returns `Yes` or `No`.

1. Ecomm sends Creative a list of images needed (i.e., those where `Have creative = No`)
1. Creative releases those images to Ecomm, who provides them to Dev
1. Dev adds the images to the image bank, which has its own dotcom project, in the `/dotcom/PROJECT_sale-image-bank_CATLP/src/img` directory
1. Dev runs `gulp dev` from within the image bank project
   - This is necessary for previewing on localhost, and for running the build
1. Dev runs `gulp build` from within the image bank project, and uploads the zip from `/dotcom/PROJECT_sale-image-bank_CATLP/build` to `sales/image-bank` in the Demandware content library
   - Note that the library folder does not contain dated folders. Upload the zip directly to `sales/image-bank`
1. Dev copies the file names of all images in `/dotcom/PROJECT_sale-image-bank_CATLP/src/img` from Finder into the `Released` tab in the shared Excel file. This automatically updates values in the `Have creative` field to `Yes` throughout the workbook. Steps:
   1. Select all of the images in Finder
   1. Issue the copy command
   1. Delete all image names on the `Released` tab (to make sure none are left over after pasting)
   1. Paste into the `Released` tab (this will paste file names only, not the file contents)

### Images for in-page navigation

Images for the in-page nav should be in PNG format, and be placed in `src/img/nav`, in locale-specific subfolders (`nav/us`, `nav/ca`, and `nav/qu`). The prebuilder will use the value of a section's ID attribute (see "Assigning section IDs" above) as the file name of the corresponding nav image. For example, the image path for a "Top Deals" section on US will be `src/img/nav/us/top-deals.png`. Some notes:

* You will need a complete set of nav images in each locale's subfolder. Many of the images will likely be duplicated across locales, although their names may differ.
* If the Ecomm merchants rename one of the sections in Excel, and the ID is being programmatically generated, you will need to rename the nav image to match the new ID. You will notice that the image needs to be renamed because it will no longer load correctly when you preview the page.

## Bug overlays

Offer blocks can optionally contain a graphic bug overlaid on the product image. Multiple bugs can appear on the same page, with some blocks having one overlay and others having another (although there can only be one overlay per block). Each type of bug should have a unique and consistent name in the `Bug overlay` column in the Excel file. The `bugOverlayImages` object in `scripts/pre-build/project/config.js` contains the file name and alt attribute for each bug overlay, keyed by the bug names from the spreadsheet. It should follow this format:

```
bugOverlayImages: {
    "BUG_NAME_FROM_SPREADSHEET": {
        src: "IMAGE_FILE_NAME",
        alt: "ALT_ATTRIBUTE"
    },
    // Additional bugs
}
```

Quebec bugs containing French text will need to be defined separately from the English versions (e.g., `EDV` and `EDV-FR` bugs). If there are no bug overlays, you can leave the object empty.

Bug overlays have default styles for size and position, but these can be overridden for a given bug. The JS will add the name of the overlay from the Excel file to the offer block's `.mel-c-sale-card__bug-overlay` element as a class (prefixed with `bug-`), and that class can be used to target a particular type of bug with a CSS selector (e.g., `.mel-c-sale-card__bug-overlay.bug-CUTIE` for a bug named `CUTIE` in the Excel file). Note that when constructing the class name, the JS will replace whitespace characters in the overlay name with dashes.

### Example

The example below will display a "Great Buy" bug on Product A, and an "EDV" bug on Product B. Note that the values in the "Bug overlay" column in Excel must exactly match the property names of the `bugOverlayImages` object.

In Excel:

| Product title | Bug overlay |
|---------------|-------------|
| Product A     | Great Buy   |
| Product B     | EDV         |

In `config.js`:

```
bugOverlayImages: {
    "Great Buy": {
        src: "great-buy.png",
        alt: "Great buy!"
    },
    "EDV": {
        src: "edv.png",
        alt: "Everyday value"
    }
}
```

## Layouts

Offer blocks can be arranged either in a mel `carousel`, or in a grid with the mel `string` component. The default is a carousel; to use a grid, include the `--grid` or `-g` flag when you run `npm run prebuild`.

The page may also contain sections of `.promo-blocks`, which are static blocks or banners that typically link to the coupon page, gift card page, etc. To align the edges of these elements with the offer blocks, `.margin-align-carousel` can be added when the offers are displayed in carousels, and `.margin-align-strings` when they are arranged in grids.

## Lazy-loading

The Sale template is configured to allow lazy-loading via the `lazysizes` plugin (with `.mel-js-lazy`) as well as Slick's built-in lazy-loader. The `pre-build` script will automatically generate the markup required to lazy-load offer blocks according to whether the offers are in a carousel. For static images on the page, such as promo blocks, the `mel-js-lazy` class and `data-src` attribute must be added manually.

## Possible enhancements to the Sale template

* The offer template (`scripts/pre-build/project/templates/offer.js`) could be refactored to perform the operations below on an offer's data. The modules from HP automation could be utilized to perform these functions (noted in parentheses)
  * Replace special characters with their HTML codes (`encodeChars`; we could alternatively use a public module for this)
  * Strip the domains `michaels.com` and `michaels.ca` from URLs, turning them into relative links (`stripUrlOrigin`). That way, offer blocks in staging would link to staging destinations, and offer blocks in production to production destinations. This would allow links to pages that aren't in production yet to be followed and previewed in staging, and it would mitigate the risk of accidentally cross-linking between staging and production
